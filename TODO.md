# TODO.md
<!-- Последняя проверка статуса: 2025-09-09; cargo check --workspace OK; cargo build --workspace компилирует, но споткнулся о OS-lock при удалении target/debug/atomd.exe; tantivy = 0.22 (lz4, mmap), zstd отключён. Тесты с --all-features блокируются зависимостью edition2024 (base64ct 1.8.0). -->
-------------------------------------------------------------------------------
[ЭТАП -1] ANTI‑MOCK ПОЛИТИКА (жёсткое исключение моков)
-------------------------------------------------------------------------------
[x] Создать `docs/policies/no-mock.md` с перечнем запрещённых практик (mock/fake/stub/insecure-dev/signature bypass/ai-mock/offline-fallback). Критерий: файл существует; политика упомянута в CONTRIBUTING.
[x] Добавить CI‑джоб `no-mock-enforcement` (scripts/no_mock_enforce.sh). Критерий: grep -R по репо не находит строки: `cfg\(feature\s*=\s*"mock"\)`, `mod mock`, `use mock`, `mockall`, `wiremock`, `httpmock`, `fake`, `stub`, `dummy`, `insecure-dev-signature`, `ai-mock`, `fs-sandbox-mock`, `offline-fallback` за исключением `docs/policies/no-mock.md`.
[ ] Добавить проверку Cargo.toml: отсутствие фич `mock`/`testonly`/`dev-bypass` в любом крейте. Критерий: скрипт парсит все Cargo.toml и падает при нахождении.
[ ] Заблокировать в CI использование dev-зависимостей в prod-коде: анализ cargo tree с `--format` и проверкой, что dev‑deps не тянутся в release профиле. Критерий: `scripts/check_dev_deps_in_release.sh` exit 0.
[x] Удалить/запретить «терминальные заглушки»: `todo!()`, `unimplemented!()`, `panic!("TODO")` вне тестов. Критерий: `ripgrep` по шаблонам возвращает 0 совпадений в src/.
[ ] Включить «fail‑closed» для всех интеграций: при недоступности сети/AI/подписи — **ошибка в UI**, а не fallback. Критерий: unit‑тесты проверяют возврат Error без обходных путей.
[ ] Добавить UI‑алерты «нет сети/нет токена/нет ключей подписи» с инструкциями. Критерий: триггеры показывают точные причины + CTA.
[ ] Ввести «белый список доменов» (Open VSX, AI endpoints) в политике сети. Критерий: попытка обращения к иным доменам → ERR_EGRESS_DENIED.

-------------------------------------------------------------------------------
[ЭТАП 0] Инварианты/репозиторий/проверяемость
-------------------------------------------------------------------------------
[x] Зафиксировать MSRV=1.82: `rust-toolchain.toml` (1.82.0, clippy, rustfmt). Критерий: `rustc -V` печатает 1.82.*.
[x] `workspace.rust-version="1.82"` в корневом Cargo.toml. Критерий: `cargo +1.82.0 check` успешен.
[ ] Строгие линты: `-D warnings`, clippy pedantic, rustfmt.toml. Критерий: clippy без предупреждений.
[x] Монорепо: /crates, /apps, workspace members. Критерий: `cargo metadata` успешен.
[ ] CI: jobs toolchain/deny/audit/vet/SBOM. Критерий: все зелёные, артефакт bom.xml загружен.
[ ] `cargo vendor` офлайн‑сборка. Критерий: `-Z offline` сборка успешна.
[x] Запрет WebView в ядре UI: `scripts/check_no_webview.sh`. Критерий: exit 0.
[x] Запрет VS Marketplace: `scripts/check_no_ms_marketplace.sh`. Критерий: exit 0.
[x] RFC‑шаблон и PR‑template с чек‑листом инвариантов. Критерий: PR показывает чек‑лист.

-------------------------------------------------------------------------------
[ЭТАП 1] Workspace/крейты/бинари
-------------------------------------------------------------------------------
[x] Создать крейты: atom-ui/core/ipc/index/lsp/plugin/sandbox/ai/settings/persistence/ext-host/atom-compat. Критерий: `cargo check -p <crate>` ок.
[x] Создать бинарники: apps/atom-ide, atomd, atom-ext-host-node. Критерий: `--help` работает.
[x] Подключить Tokio 1.40+ (rt-multi-thread, macros, signal). Критерий: #[tokio::test] проходит.
[x] Release профиль: lto="thin", codegen-units=1. Критерий: release сборка отображает thin LTO. (Включено в корневом Cargo.toml)

-------------------------------------------------------------------------------
[ЭТАП 2] IPC (фрейминг/таймауты/отмена/идемпотентность)
-------------------------------------------------------------------------------
[Статус на 2025-09-09] Реализовано в коде: типы `IpcMessage`/`IpcPayload`/`CoreRequest`/`CoreResponse`, заголовок фрейма `FrameHeader` (magic/ver/flags/len/crc32), функции `read_ipc_message`/`write_ipc_message`, таймауты и `Cancel` на стороне клиента. Лимит кадра сейчас 64 MiB (константа `MAX_MESSAGE_SIZE`), требуется унифицировать до 1 MiB по политике и сделать его конфигурируемым. На сервере `IpcPayload::Cancel` пока не обрабатывается; нет backpressure/лимитов очередей и round-trip тестов на фрейминг.
[ ] Типы: RpcEnvelope{request_id,deadline_millis,payload}, CoreReq/Resp. Критерий: сериализация round-trip.
[ ] Length‑prefix encoder/decoder + лимит кадра (1 MiB конфиг). Критерий: oversize → ERR_FRAME_TOO_LARGE.
[x] Серверная часть IPC (MVP): bincode‑фрейминг, Ping/Open/Save/Close/Search (ripgrep). Критерий: atomd слушает 127.0.0.1:8877 и отвечает.
[ ] TCP listener 127.0.0.1:9876 в atomd. Критерий: nc коннектится.
[ ] Ping→Pong маршрут. Критерий: pong за один RTT.
[ ] Deadline‑reject. Критерий: просроченный запрос → ERR_DEADLINE.
[ ] Cancel‑token. Критерий: отменённый Grep прекращает стрим чанков ≤50мс.
[ ] Bounded очереди + backpressure. Критерий: переполнение → ERR_BACKPRESSURE.
[ ] Идемпотентность OpenWorkspace по request_id (TTL‑кеш). Критерий: повтор → байтово тот же ответ.
[ ] Логи/метрики IPC (tracing/OTLP). Критерий: записи видны в collector.

-------------------------------------------------------------------------------
[ЭТАП 3] UI Slint ≥1.13 (окно/панели/A11y)
-------------------------------------------------------------------------------
[ ] Зависимость slint="=1.13.*", slint-build; build.rs. Критерий: окно открывается.
[ ] Компоненты: TabBar/TreeView/StatusBar/CommandPalette. Критерий: клики логируются.
[ ] winit (IME/HiDPI/Wayland/AppKit/Win32). Критерий: ввод отображается.
[ ] A11y роли + TAB‑навигация. Критерий: циклический фокус.
[ ] Связка UI↔IPC: «Открыть папку» → OpenWorkspace. Критерий: Ok от daemon.
[ ] Проверка отсутствия webview в dependency graph. Критерий: скрипт exit 0.

-------------------------------------------------------------------------------
[ЭТАП 4] Редактор (ropey/cosmic‑text/undo/multicursor)
-------------------------------------------------------------------------------
[ ] Buffer::from_path() с mmap; BOM/encoding детект. Критерий: файл >100MB открывается, RAM < размер.
[ ] Нормализация перев. строк (CRLF/LF) и сохранение исходного стиля. Критерий: тест ок.
[ ] cosmic‑text + кэш глифов. Критерий: второй скролл дешевле первого.
[ ] Undo/redo с чекпойнтами (fsync). Критерий: insert×3→undo×3 возвращает исходник.
[ ] Мультикурсор/прямоугольное выделение. Критерий: ALT+drag множит вставку.
[ ] Soft‑wrap/column guides. Критерий: переключение не репарсит вне viewport.

-------------------------------------------------------------------------------
[ЭТАП 5] tree‑sitter 0.25.x (ABI 15) и подсветка
-------------------------------------------------------------------------------
[ ] Проверка ABI=15 юнит‑тестом. Критерий: тест зелёный.
[ ] Парсеры Rust/TS/JS совместимых версий подключены. Критерий: parse() без ошибок.
[ ] Прогресс‑колбек и отмена парсинга по тайм‑ауту. Критерий: прерывается корректно.
[ ] *.scm queries для подсветки/складок. Критерий: инкрементальное обновление.

-------------------------------------------------------------------------------
[ЭТАП 6] Поиск (ripgrep) + Индекс (Tantivy)
-------------------------------------------------------------------------------
[ ] Проверка наличия `rg` в PATH (ошибка, если отсутствует). Критерий: UI алерт c инструкцией, без fallback.
[ ] Запуск `rg --json` со streaming‑парсингом. Критерий: первый чанк до завершения процесса.
[ ] Отмена поиска → kill процесса. Критерий: после cancel новые чанки не приходят.
[ ] Уважение .gitignore + include/exclude фильтры. Критерий: тест ок.
[ ] Tantivy 0.25: схема (path,symbol,kind,range,text). Критерий: индекс создан.
[ ] Переиндексация по save/rename/delete. Критерий: документ обновлён/удалён.
[ ] Низкий приоритет индексатора при вводе. Критерий: latency ввода стабилен.

-------------------------------------------------------------------------------
[ЭТАП 7] LSP 3.17 (реальные сервера, без заглушек)
-------------------------------------------------------------------------------
[ ] Поиск `rust-analyzer`/`typescript-language-server`. Критерий: `atom lsp list` печатает пути (ошибка если не найдено).
[ ] Конфиг `~/.atom/lsp.toml` (пути/аргументы). Критерий: валиден, схема пройдена.
[ ] initialize/initialized, capabilities. Критерий: сервер отвечает capabilities.
[ ] didOpen/didChange/didClose. Критерий: приходят diagnostics.
[ ] hover/completion (debounce, viewport‑scope). Критерий: всплывашка и список работают.
[ ] Supervision: перезапуск после kill. Критерий: авто‑рестарт успешен.
[ ] Маппинг Rope↔LSP (UTF‑16). Критерий: подсветка позиционно корректна.

-------------------------------------------------------------------------------
[ЭТАП 8] Persistence и настройки
-------------------------------------------------------------------------------
[ ] rusqlite + PRAGMA WAL. Критерий: возвращает "wal".
[ ] Миграция v1: sessions, open_files. Критерий: таблицы существуют.
[ ] save_session()/restore_session(). Критерий: после рестарта состояние совпадает.
[ ] ~/.atom/config.toml (defaults+overlay). Критерий: editor.tabSize применяется live.
[ ] Валидация типов (schemars/serde). Критерий: неверный тип → ошибка.

-------------------------------------------------------------------------------
[ЭТАП 9] Безопасность/песочница (PoLA, ключи, сеть)
-------------------------------------------------------------------------------
[ ] policies.toml (capabilities fs/net/proc/ui). Критерий: неизвестные ключи → ошибка.
[ ] OS‑keychain (DPAPI/Keychain/libsecret) для секретов. Критерий: запись/чтение токена ок; лог редактирует секреты.
[ ] Сетевой брокер deny‑by‑default + allowlist доменов (Open VSX, AI). Критерий: неразрешённый хост → ERR_EGRESS_DENIED.
[ ] FS‑брокер preopen каталоги (WASM/Native). Критерий: вне preopen → ERR_FS_DENIED.
[ ] Crash‑loop breaker подпроцессов. Критерий: >3 падений/мин → backoff и алерт.

-------------------------------------------------------------------------------
[ЭТАП 10] Хост плагинов (Wasmtime 36.x LTS, **реальная подпись**)
-------------------------------------------------------------------------------
[ ] wasmtime="=36.*" + fuel/epoch. Критерий: топливо убывает; epoch прерывает.
[ ] Формат `.apx`: zip + `apx.toml` + `sig.cose`. Критерий: чтение манифеста и подписи.
[ ] Реальная верификация подписи (Ed25519 COSE): добавить `coset`/`ed25519-dalek`. Критерий: неподписанный/подписанный пакеты корректно отвергаются/принимаются.
[ ] Trust‑store ключей (`~/.atom/trust/keys.json`) + ротация. Критерий: удалённый ключ → установка блокируется.
[ ] Host‑функции: print/get/set buffer, alloc/free. Критерий: wasm‑плагин меняет буфер.
[ ] Изоляция store‑на‑плагин. Критерий: память не разделяется.
[ ] Логирование и cap‑проверки host‑вызовов. Критерий: неразрешённая операция блокируется.

-------------------------------------------------------------------------------
[ЭТАП 11] VS Code совместимость (Open VSX **живьём**)
-------------------------------------------------------------------------------
[ ] product.json: serviceUrl/itemUrl = Open VSX. Критерий: загрузка метаданных успешна.
[ ] ext‑host Node LTS 20/22 (отдельный процесс). Критерий: процесс стартует, RPC есть.
[ ] `vscode.window.showInformationMessage`. Критерий: hello‑extension показывает сообщение.
[ ] `vscode.workspace.openTextDocument`. Критерий: документ открывается.
[ ] `vscode.commands.registerCommand`. Критерий: команда вызывается.
[ ] Webview CSP строгий (no inline). Критерий: inline-скрипт блокируется.
[ ] Ограничения child_process/сети через брокеры. Критерий: прямой spawn без политики → отказ.
[ ] Интеграционный тест установки `.vsix` с Open VSX (реальный запрос). Критерий: скачивание/установка успешны; при оффлайне — явная ошибка без fallback.

-------------------------------------------------------------------------------
[ЭТАП 12] Совместимость с Atom (legacy)
-------------------------------------------------------------------------------
[ ] Shim `atom.*` (workspace/commands/config/keymaps/services/grammars/themes). Критерий: пример legacy‑пакета вызывает API.
[ ] CoffeeScript транспиляция при установке. Критерий: `.coffee` конвертируется и грузится.
[ ] Загрузка пакетов из GitHub Releases/зеркал. Критерий: артефакт скачан; манифест конвертирован.
[ ] Те же брокеры FS/NET/PROC. Критерий: попытки побега блокируются.

-------------------------------------------------------------------------------
[ЭТАП 13] AI: Claude Code SDK + Hooks + MCP (**только реальный доступ**)
-------------------------------------------------------------------------------
[ ] Подключить официальные SDK (TS/Python) согласно гайдам. Критерий: сборка успешна.
[ ] Настроить реальный OAuth вход (Claude Code) в UI. Критерий: пользователь проходит вход, токен в OS‑keychain.
[ ] Запретить любой offline‑режим AI: фича‑флаг `ai_offline` отсутствует; попытки использовать без сети → явная ошибка. Критерий: тесты подтверждают «fail‑closed».
[ ] Реализовать хуки: PreToolUse/PostToolUse/Stop/UserPromptSubmit. Критерий: хук может заблокировать инструмент; события логируются.
[ ] MCP клиент (ревизия 2025‑06‑18): без batching, структурированный вывод. Критерий: обмен ресурсами успешен.
[ ] AI‑панель: выполнение реальной команды «вставь комментарий» → модификация буфера. Критерий: diff содержит вставку; логи содержат request/response id.
[ ] Политики rate‑limit/конкурентности/таймаутов AI. Критерий: превышение лимитов → контролируемая ошибка.
[ ] Редакция логов (секреты скрыты). Критерий: токены не видны в логах.

-------------------------------------------------------------------------------
[ЭТАП 14] Телеметрия/KPI (реальный OTLP)
-------------------------------------------------------------------------------
[ ] Включить tracing + OTLP экспорт (endpoint из секретов CI/локально через collector). Критерий: записи видны.
[ ] KPI: startup/open-project/input-latency/RAM. Критерий: публикуются перцентили P50/P95.
[ ] Perf‑гейты в CI: превышение порогов валит джобу. Критерий: ошибочный бранч падает.
[ ] HTML‑отчёт (jsonl→html) в artifacts. Критерий: файл с перцентилями доступен.

-------------------------------------------------------------------------------
[ЭТАП 15] Watchers (inotify/FSEvents/ReadDirectoryChangesW)
-------------------------------------------------------------------------------
[ ] Проверка fs.inotify.max_user_watches (Linux) и алерт. Критерий: предупреждение в UI.
[ ] macOS FSEvents адаптер. Критерий: события create/rename/delete приходят.
[ ] Windows OVERLAPPED обработка пачек. Критерий: без потерь.
[ ] Дедуп событий; троттлинг индексатора при вводе. Критерий: latency ввода стабилен.

-------------------------------------------------------------------------------
[ЭТАП 16] Сборка/подпись/доставка (реальные цепочки)
-------------------------------------------------------------------------------
[ ] Матрица CI: win/mac/linux x64+arm64. Критерий: 6 таргетов собираются.
[ ] Windows: SignTool/EV‑сертификат; MSI/MSIX. Критерий: локальная подпись проходит.
[ ] macOS: codesign + notarytool. Критерий: получен notarization ticket.
[ ] Linux: .deb/.rpm; опц. AppImage/Flatpak. Критерий: установка успешна.
[ ] Автообновления: дельты, staged rollout, быстрый rollback. Критерий: апдейт/откат проходят.

-------------------------------------------------------------------------------
[ЭТАП 17] QA/совместимость/безопасность
-------------------------------------------------------------------------------
[ ] Smoke набор Open VSX расширений (живой каталог). Критерий: сценарии без падений.
[ ] LSP 3.17 конформанс‑набор. Критерий: кейсы зелёные.
[ ] Security‑suite: FS/NET/PROC побеги, OOM/fuel‑exhaustion (WASM). Критерий: блокируются/ограничиваются.
[ ] Webview CSP: попытка inline‑скрипта (ext). Критерий: блокируется.
[ ] Е2Е: открыть/редактировать/сохранить/перезапуск IDE. Критерий: все шаги ок.

-------------------------------------------------------------------------------
[КОНТРОЛЬНЫЕ ТОЧКИ MVP (живые сценарии, без моков)]
-------------------------------------------------------------------------------
[ ] A‑1: Открыть папку → дерево/вкладки работают. Критерий: demo/open_folder.sh exit 0 и скриншот окна.
[ ] A‑2: grep (ripgrep) инкрементально + отмена. Критерий: ≥1 чанк → отмена → тишина.
[ ] A‑3: LSP hover/completion для Rust/TS (реальные сервера). Критерий: demo/lsp.sh печатает hover и ≥3 items.
[ ] A‑4: Установка `.vsix` из Open VSX (реальная сеть) и запуск hello‑extension. Критерий: demo/open-vsx.sh exit 0.
[ ] A‑5: AI‑команда «вставь комментарий» (реальные ключи/сеть) → модификация буфера. Критерий: diff содержит вставку.

-------------------------------------------------------------------------------
[ANTI‑MOCK ГЕЙТЫ: список запретов в коде/инфраструктуре]
-------------------------------------------------------------------------------
[ ] Нет `cfg(feature="mock")`/`feature = "mock"` в Cargo.*. Критерий: grep ничего не находит.
[ ] Нет модулей/импортов с `mock*`, `fake*`, `stub*`, `dummy*`. Критерий: grep пусто.
[ ] Нет строк `insecure-dev-signature`, `ai-mock`, `fs-sandbox-mock`, `offline-fallback`. Критерий: grep пусто.
[ ] Нет зависимостей `mockall`, `wiremock`, `httpmock` вне тестов (а лучше — вообще). Критерий: cargo tree показывает 0.
[ ] Любая недоступность сети/AI/подписей → пользовательская **ошибка**, а не обход. Критерий: интеграционные тесты «fail‑closed» зелёные.

-------------------------------------------------------------------------------
[АРТЕФАКТЫ/СЕКРЕТЫ (реальные)]
-------------------------------------------------------------------------------
[ ] Секреты CI: OTLP_ENDPOINT, OPEN_VSX_TOKEN (если требуется), CLAUDE_CODE_CLIENT_ID/SECRET/REDIRECT_URI. Критерий: переменные доступны job’ам; в логах скрыты.
[ ] Траст‑стор ключей для `.apx`: `~/.atom/trust/keys.json`. Критерий: чтение/валидация.
[ ] Логи: `~/.atom/daemon.log`, `~/.atom/lsp-*.log` — без секретов (редакция включена). Критерий: сканы не находят токенов.
