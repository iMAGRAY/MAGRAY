# RFC-0001: Хоткеи в IDE (Esc/F5) и миграция Slint при соблюдении MSRV

Статус: Draft

Автор(ы): Atom IDE Team

Дата: 2025-09-10

## Кратко

Нужно добавить хоткеи в IDE: Esc → Cancel (отмена текущего поиска), F5 → Open Folder. Текущая версия Slint в проекте — 1.5.0 (софт‑рендерер, backend‑winit). В Slint 1.5 отсутствует стабильный и поддерживаемый механизм глобальной обработки клавиш/Shortcut в std‑widgets, позволяющий реализовать хоткеи без платформенных обходов. В более новых версиях Slint соответствующий функционал появляется, но цепляет зависимость `i-slint-core-macros 1.13.0`, которая требует Cargo feature `edition2024`. Это несовместимо с нашим инвариантом MSRV=1.82 (stable) и политикой избегать зависимостей, требующих edition2024.

RFC предлагает безопасный маршрут: оформить фазовую миграцию Slint, не нарушая стабильность проекта и наших инвариантов, с чёткими условиями включения хоткеев.

## Цели

- Поддержать хоткеи Esc/F5 в IDE без «костылей» и нестабильных трюков.
- Сохранить детерминизм сборки и совместимость с MSRV для остальной части монорепо.
- Дать чёткий план действий, флаги и критерии готовности.

## Не цели

- Не добавлять обходы/платформенные перехватчики клавиатуры, выходящие за рамки Slint.
- Не понижать требования безопасности/политик проекта.

## Ограничения/фон

- MSRV: 1.82.0 (stable). На момент 2025‑09‑10 `edition2024` для Cargo нестабилен на 1.82 и требует nightly.
- Slint ≥ 1.13 тянет `i-slint-core-macros 1.13.0`, которые требуют `edition2024`.
- Наш UI использует Slint (software renderer + backend‑winit), без WebView.

## Варианты

1) Обновить Slint ≥ 1.13 и собирать IDE (только UI часть) на `cargo +nightly` с включённым `edition2024`, сохранив весь наш код в edition=2021. Вся остальная workspace собирается на stable 1.82. Проекты остаются совместимыми, UI сборка изолируется в отдельную CI‑задачу. Включить хоткеи на основе поддерживаемых механизмов Slint.

2) Ждать стабилизации `edition2024` в stable toolchain, затем обновить Slint и включить хоткеи на stable. Риск — отложенная поставка функционала.

3) Переписать хоткеи поверх winit без участия Slint. Отклоняется как «костыль» и потенциально конфликтует с архитектурой UI.

Рекомендация: (1) как мостовое решение до стабилизации `edition2024`, затем перейти к (2).

## План внедрения (этапы)

Этап A — Подготовка (без изменения поведения в релизе)
- Зафиксировать Slint в стабильной версии для stable‑сборок (оставляем `=1.5.0` для `--no-default-features` билда).
- Добавить отдельный CI‑job `tests-windows-ui-nightly`/`tests-linux-ui-nightly` (по необходимости), который собирает только UI (`apps/atom-ide` с `--features ui`) на `cargo +nightly` с целевым Slint ≥ 1.13, не распространяя nightly на весь workspace.
- Никаких включений в дефолтный релизный pipeline.

Этап B — Функционал хоткеев (в UI ночной сборкой)
- Поднять Slint в UI‑конфигурации (nightly job) до версии (например) 1.13.x.
- Реализовать хоткеи Esc/F5 через поддерживаемые API Slint.
- Добавить E2E UI‑тесты (Windows и, при возможности, Linux/X11) на проверку хоткеев (симуляция клавиш) + видимый эффект в UI.

Этап C — Переход на stable, когда `edition2024` стабилизируется
- Перевести nightly‑сборки на stable (минимальная требуемая версия Cargo/Rust, где `edition2024` поддержан на уровне зависимостей).
- Включить хоткеи в стандартный релизный pipeline.

## Изменения в CI (предлагается)

- Новый job в Actions: `tests-windows-ui-nightly` (и/или linux), с шагами:
  - `rustup toolchain install nightly`
  - Сборка: `cargo +nightly build -p atom-ide --features ui`
  - Тест: `cargo +nightly test -p atom-ide --features ui --test e2e_ui -- --test-threads=1`
  - Cleanup процессов.
- Без влияния на существующие stable‑job’ы.

## Риски

- Nightly может ломаться/меняться — минимизируем, ограничив Nightly только в UI job, и закрепив версии Slint.
- Долгая стабилизация `edition2024` — функционал хоткеев может быть доступен только в nightly‑job до стабилизации.
- Потенциальные различия поведения UI между версиями Slint — покрываем E2E тестами и smoke‑тестами.

## Тестирование/приёмка

- E2E: GUI‑smoke + хоткеи (Esc — отмена поиска, F5 — открытие папки). В headless сценариях при необходимости — имитация.
- Регрессия: стабильные тесты IPC/daemon/IDE headless остаются зелёными на stable.

## График

- A (Подготовка RFC/CI job): 1–2 дня.
- B (Функционал хоткеев под nightly UI): 1–2 дня на реализацию + E2E.
- C (Stable переход): зависит от стабилизации `edition2024` в Cargo.

## Обновления политик

- Добавить в CONTRIBUTING/README краткую сноску: «Hotkeys в UI задействуют Slint ≥ 1.13 и требуют nightly в CI до стабилизации edition2024; основной код проекта остаётся на edition 2021/MSRV 1.82».

## Решение

Draft: рекомендован вариант (1) → (2). Требуется согласование владельцев инвариантов (MSRV/edition) и CI.

